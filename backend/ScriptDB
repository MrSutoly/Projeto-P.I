-- Criar banco e usar
CREATE DATABASE IF NOT EXISTS ProjectPI;
USE ProjectPI;

-- Usuários
CREATE TABLE IF NOT EXISTS usuarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    role ENUM('admin', 'professor', 'aluno') NOT NULL
);

-- Turmas
CREATE TABLE IF NOT EXISTS turmas (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    codigo VARCHAR(6) NOT NULL UNIQUE,
    professor_id INT NOT NULL,
    FOREIGN KEY (professor_id) REFERENCES usuarios(id) ON DELETE CASCADE
);

-- Relacionamento 1:N (turmas para usuários)
ALTER TABLE usuarios
ADD COLUMN class_id INT,
ADD FOREIGN KEY (class_id) REFERENCES turmas(id) ON DELETE SET NULL;

-- Atividades
CREATE TABLE IF NOT EXISTS atividades (
    id INT AUTO_INCREMENT PRIMARY KEY,
    titulo VARCHAR(100) NOT NULL,
    descricao TEXT,
    link_constante TEXT
);

-- Semanas
CREATE TABLE IF NOT EXISTS semanas (
    numero INT PRIMARY KEY,
    data_inicio DATE NOT NULL,
    data_fim DATE NOT NULL
);

-- Relacionamento atividade/semana
ALTER TABLE atividades
ADD COLUMN semana_numero INT,
ADD FOREIGN KEY (semana_numero) REFERENCES semanas(numero);

-- Quizzes (um quiz completo com várias perguntas)
CREATE TABLE IF NOT EXISTS quizzes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    titulo VARCHAR(100) NOT NULL,
    tipo ENUM('kahoot', 'clicar_objeto') NOT NULL,
    criado_por INT NOT NULL,
    FOREIGN KEY (criado_por) REFERENCES usuarios(id) ON DELETE CASCADE
);

-- Perguntas (várias por quiz)
CREATE TABLE IF NOT EXISTS perguntas (
    id INT AUTO_INCREMENT PRIMARY KEY,
    texto TEXT NOT NULL,
    quiz_id INT NOT NULL,
    FOREIGN KEY (quiz_id) REFERENCES quizzes(id) ON DELETE CASCADE
);

-- Opções de resposta (4 por pergunta, 1 correta)
CREATE TABLE IF NOT EXISTS opcoes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    texto TEXT NOT NULL,
    correta BOOLEAN NOT NULL DEFAULT FALSE,
    pergunta_id INT NOT NULL,
    FOREIGN KEY (pergunta_id) REFERENCES perguntas(id) ON DELETE CASCADE
);

-- Respostas dos usuários
CREATE TABLE IF NOT EXISTS respostas (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT,
    pergunta_id INT,
    opcao_id INT,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE,
    FOREIGN KEY (pergunta_id) REFERENCES perguntas(id) ON DELETE CASCADE,
    FOREIGN KEY (opcao_id) REFERENCES opcoes(id) ON DELETE CASCADE
);

-- Pontuações
CREATE TABLE IF NOT EXISTS pontuacoes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    pontos INT NOT NULL,
    completude BOOLEAN DEFAULT TRUE,
    class_id INT,
    resposta_id INT,
    FOREIGN KEY (class_id) REFERENCES turmas(id),
    FOREIGN KEY (resposta_id) REFERENCES respostas(id) ON DELETE CASCADE
);

-- Reciclagem
CREATE TABLE IF NOT EXISTS reciclagem (
    id INT AUTO_INCREMENT PRIMARY KEY,
    quantidade INT NOT NULL,
    class_id INT,
    FOREIGN KEY (class_id) REFERENCES turmas(id)
);

-- Links para atividades
CREATE TABLE IF NOT EXISTS links_atividade (
    id INT AUTO_INCREMENT PRIMARY KEY,
    url TEXT NOT NULL,
    class_id INT,
    FOREIGN KEY (class_id) REFERENCES turmas(id)
);

-- Sessões de Quiz
CREATE TABLE IF NOT EXISTS quiz_sessions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    quiz_id INT NOT NULL,
    professor_id INT NOT NULL,
    turma_id INT NOT NULL,
    status ENUM('aguardando', 'em_andamento', 'finalizado') NOT NULL DEFAULT 'aguardando',
    pergunta_atual INT NOT NULL DEFAULT 1,
    codigo_acesso VARCHAR(10) NOT NULL UNIQUE,
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (quiz_id) REFERENCES quizzes(id) ON DELETE CASCADE,
    FOREIGN KEY (professor_id) REFERENCES usuarios(id) ON DELETE CASCADE,
    FOREIGN KEY (turma_id) REFERENCES turmas(id) ON DELETE CASCADE,
    INDEX (status),
    INDEX (professor_id),
    INDEX (turma_id)
);

-- Respostas dos Alunos em Sessão de Quiz
CREATE TABLE IF NOT EXISTS quiz_respostas_alunos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    sessao_id INT NOT NULL,
    aluno_id INT NOT NULL,
    pergunta_id INT NOT NULL,
    resposta_id INT NOT NULL,
    tempo_resposta INT,
    respondido_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (sessao_id) REFERENCES quiz_sessions(id) ON DELETE CASCADE,
    FOREIGN KEY (aluno_id) REFERENCES usuarios(id) ON DELETE CASCADE,
    FOREIGN KEY (pergunta_id) REFERENCES perguntas(id) ON DELETE CASCADE,
    FOREIGN KEY (resposta_id) REFERENCES opcoes(id) ON DELETE CASCADE,
    UNIQUE KEY unique_resposta (sessao_id, aluno_id, pergunta_id),
    INDEX (sessao_id, pergunta_id)
);

-- Alunos Conectados à Sessão de Quiz
CREATE TABLE IF NOT EXISTS quiz_alunos_conectados (
    id INT AUTO_INCREMENT PRIMARY KEY,
    sessao_id INT NOT NULL,
    aluno_id INT NOT NULL,
    status ENUM('conectado', 'desconectado') NOT NULL DEFAULT 'conectado',
    conectado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (sessao_id) REFERENCES quiz_sessions(id) ON DELETE CASCADE,
    FOREIGN KEY (aluno_id) REFERENCES usuarios(id) ON DELETE CASCADE,
    UNIQUE KEY unique_conexao (sessao_id, aluno_id),
    INDEX (status)
);
